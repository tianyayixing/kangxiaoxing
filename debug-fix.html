<!DOCTYPE html>
<html>
<head>
    <title>Debug LocalStorage Fix</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .danger {
            background-color: #dc3545;
        }
        .danger:hover {
            background-color: #c82333;
        }
        pre {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            overflow-x: auto;
        }
        .section {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>LocalStorage Debug & Fix</h1>
    
    <div class="section">
        <h2>æ£€æŸ¥æ•°æ®</h2>
        <button onclick="checkData()">æ£€æŸ¥æ‰€æœ‰æ•°æ®</button>
        <button onclick="checkDietPlan()">æ£€æŸ¥é¥®é£Ÿè®¡åˆ’</button>
        <button onclick="checkUserSettings()">æ£€æŸ¥ç”¨æˆ·è®¾ç½®</button>
    </div>
    
    <div class="section">
        <h2>ä¿®å¤æ•°æ®</h2>
        <button onclick="fixDietPlanData()">ä¿®å¤é¥®é£Ÿè®¡åˆ’æ•°æ®</button>
        <button onclick="restoreSampleData()" class="danger">æ¢å¤ç¤ºä¾‹æ•°æ®</button>
    </div>
    
    <div class="section">
        <h2>æ¸…ç©ºæ•°æ®</h2>
        <button onclick="clearAllData()" class="danger">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
    </div>
    
    <div id="output"></div>

    <script>
        // å¯†é’¥ï¼ˆä¸åº”ç”¨ä¸­ä¸€è‡´ï¼‰
        const SECRET_KEY = 'diet-manager-secret-key-2024';
        
        // å­˜å‚¨é”®å
        const STORAGE_KEYS = {
            USER_SETTINGS: 'user_settings',
            DIET_PLAN: 'diet_plan',
            DISH_HISTORY: 'dish_history',
            WEEKLY_REPORTS: 'weekly_reports',
            FIRST_LAUNCH: 'first_launch',
            CUSTOM_DISHES: 'custom_dishes',
            DELETED_SYSTEM_DISHES: 'deleted_system_dishes',
            MODIFIED_SYSTEM_DISHES: 'modified_system_dishes'
        };
        
        // å¼•å…¥CryptoJSåº“
        function loadCryptoJS() {
            return new Promise((resolve, reject) => {
                if (window.CryptoJS) {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
        
        // åŠ å¯†æ•°æ®
        function encrypt(data) {
            if (!window.CryptoJS) {
                throw new Error('CryptoJSæœªåŠ è½½');
            }
            const jsonStr = JSON.stringify(data);
            return CryptoJS.AES.encrypt(jsonStr, SECRET_KEY).toString();
        }
        
        // è§£å¯†æ•°æ®
        function decrypt(ciphertext) {
            if (!window.CryptoJS) {
                throw new Error('CryptoJSæœªåŠ è½½');
            }
            try {
                const bytes = CryptoJS.AES.decrypt(ciphertext, SECRET_KEY);
                const decryptedData = bytes.toString(CryptoJS.enc.Utf8);
                return JSON.parse(decryptedData);
            } catch (error) {
                console.error('è§£å¯†å¤±è´¥:', error);
                return null;
            }
        }
        
        // æ£€æŸ¥æ‰€æœ‰æ•°æ®
        async function checkData() {
            await loadCryptoJS();
            const output = document.getElementById('output');
            try {
                let result = '<h2>å­˜å‚¨æ•°æ®æ£€æŸ¥ç»“æœ:</h2>';
                
                Object.entries(STORAGE_KEYS).forEach(([key, storageKey]) => {
                    const data = localStorage.getItem(storageKey);
                    if (data) {
                        try {
                            const decrypted = decrypt(data);
                            result += `<p><strong>${key} (${storageKey}):</strong></p><pre>${JSON.stringify(decrypted, null, 2)}</pre>`;
                        } catch (e) {
                            result += `<p><strong>${key} (${storageKey}):</strong> ${data} (æ— æ³•è§£å¯†: ${e.message})</p>`;
                        }
                    } else {
                        result += `<p><strong>${key} (${storageKey}):</strong> æ— æ•°æ®</p>`;
                    }
                });
                
                output.innerHTML = result;
            } catch (error) {
                output.innerHTML = `<p>é”™è¯¯: ${error.message}</p>`;
            }
        }
        
        // æ£€æŸ¥é¥®é£Ÿè®¡åˆ’
        async function checkDietPlan() {
            await loadCryptoJS();
            const output = document.getElementById('output');
            try {
                const data = localStorage.getItem(STORAGE_KEYS.DIET_PLAN);
                if (data) {
                    try {
                        const decrypted = decrypt(data);
                        output.innerHTML = `<h2>é¥®é£Ÿè®¡åˆ’æ•°æ®:</h2><pre>${JSON.stringify(decrypted, null, 2)}</pre>`;
                    } catch (e) {
                        output.innerHTML = `<p>é¥®é£Ÿè®¡åˆ’æ•°æ®æ— æ³•è§£å¯†: ${e.message}</p>`;
                    }
                } else {
                    output.innerHTML = `<p>æ— é¥®é£Ÿè®¡åˆ’æ•°æ®</p>`;
                }
            } catch (error) {
                output.innerHTML = `<p>æ£€æŸ¥é¥®é£Ÿè®¡åˆ’æ—¶å‡ºé”™: ${error.message}</p>`;
            }
        }
        
        // æ£€æŸ¥ç”¨æˆ·è®¾ç½®
        async function checkUserSettings() {
            await loadCryptoJS();
            const output = document.getElementById('output');
            try {
                const data = localStorage.getItem(STORAGE_KEYS.USER_SETTINGS);
                if (data) {
                    try {
                        const decrypted = decrypt(data);
                        output.innerHTML = `<h2>ç”¨æˆ·è®¾ç½®æ•°æ®:</h2><pre>${JSON.stringify(decrypted, null, 2)}</pre>`;
                    } catch (e) {
                        output.innerHTML = `<p>ç”¨æˆ·è®¾ç½®æ•°æ®æ— æ³•è§£å¯†: ${e.message}</p>`;
                    }
                } else {
                    output.innerHTML = `<p>æ— ç”¨æˆ·è®¾ç½®æ•°æ®</p>`;
                }
            } catch (error) {
                output.innerHTML = `<p>æ£€æŸ¥ç”¨æˆ·è®¾ç½®æ—¶å‡ºé”™: ${error.message}</p>`;
            }
        }
        
        // ä¿®å¤é¥®é£Ÿè®¡åˆ’æ•°æ®
        async function fixDietPlanData() {
            await loadCryptoJS();
            const output = document.getElementById('output');
            try {
                const data = localStorage.getItem(STORAGE_KEYS.DIET_PLAN);
                if (data) {
                    try {
                        const decrypted = decrypt(data);
                        // ç¡®ä¿æ•°æ®ç»“æ„æ­£ç¡®
                        const days = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'];
                        const mealTypes = ['breakfast', 'lunch', 'dinner', 'snack'];
                        
                        // åˆå§‹åŒ–æ•°æ®ç»“æ„
                        const fixedPlan = {};
                        days.forEach(day => {
                            if (!decrypted[day]) {
                                fixedPlan[day] = {};
                                mealTypes.forEach(meal => {
                                    fixedPlan[day][meal] = [];
                                });
                            } else {
                                fixedPlan[day] = {};
                                mealTypes.forEach(meal => {
                                    fixedPlan[day][meal] = decrypted[day][meal] || [];
                                });
                            }
                        });
                        
                        // ä¿å­˜ä¿®å¤åçš„æ•°æ®
                        const encrypted = encrypt(fixedPlan);
                        localStorage.setItem(STORAGE_KEYS.DIET_PLAN, encrypted);
                        
                        output.innerHTML = `<h2>é¥®é£Ÿè®¡åˆ’æ•°æ®å·²ä¿®å¤:</h2><pre>${JSON.stringify(fixedPlan, null, 2)}</pre>`;
                    } catch (e) {
                        output.innerHTML = `<p>ä¿®å¤é¥®é£Ÿè®¡åˆ’æ•°æ®æ—¶å‡ºé”™: ${e.message}</p>`;
                    }
                } else {
                    output.innerHTML = `<p>æ— é¥®é£Ÿè®¡åˆ’æ•°æ®éœ€è¦ä¿®å¤</p>`;
                }
            } catch (error) {
                output.innerHTML = `<p>ä¿®å¤é¥®é£Ÿè®¡åˆ’æ—¶å‡ºé”™: ${error.message}</p>`;
            }
        }
        
        // æ¢å¤ç¤ºä¾‹æ•°æ®
        async function restoreSampleData() {
            await loadCryptoJS();
            const output = document.getElementById('output');
            try {
                // ç¤ºä¾‹ç”¨æˆ·è®¾ç½®
                const sampleSettings = {
                    name: "å¼ ä¸‰",
                    age: 25,
                    weight: 65,
                    height: 170,
                    dietPreference: ["omnivore"],
                    dietGoal: "maintain",
                    healthStatus: "normal",
                    allergies: []
                };
                
                // ç¤ºä¾‹é¥®é£Ÿè®¡åˆ’
                const samplePlan = {
                    "å‘¨ä¸€": {
                        breakfast: [{ id: 1, name: "ç…è›‹", category: "æ—©é¤", calories: 155, protein: 13, fat: 11, carbs: 1, fiber: 0, vitaminC: 0, vitaminB: 8, image: "ğŸ³", cookingMethod: "çƒ­é”…åŠ æ²¹ï¼Œæ‰“å…¥é¸¡è›‹ï¼Œç…è‡³ä¸¤é¢é‡‘é»„", effect: "å¯Œå«è›‹ç™½è´¨ï¼Œæä¾›èƒ½é‡" }],
                        lunch: [{ id: 19, name: "é¸¡èƒ¸è‚‰", category: "è‚‰ç±»", calories: 165, protein: 31, fat: 3.6, carbs: 0, fiber: 0, vitaminC: 0, vitaminB: 25, image: "ğŸ—", cookingMethod: "ç…ã€ç…®æˆ–çƒ¤", effect: "ä½è„‚é«˜è›‹ç™½ï¼Œé€‚åˆå¥èº«" }],
                        dinner: [{ id: 31, name: "ç•ªèŒ„ç‚’è›‹", category: "å®¶å¸¸èœ", calories: 120, protein: 8, fat: 7, carbs: 8, fiber: 1.5, vitaminC: 12, vitaminB: 10, image: "ğŸ³", cookingMethod: "å…ˆç‚’è›‹åç‚’ç•ªèŒ„", effect: "è¥å…»å‡è¡¡ï¼Œæ˜“æ¶ˆåŒ–" }],
                        snack: [{ id: 26, name: "è‹¹æœ", category: "æ°´æœ", calories: 52, protein: 0.3, fat: 0.2, carbs: 14, fiber: 2.4, vitaminC: 5, vitaminB: 3, image: "ğŸ", cookingMethod: "ç›´æ¥é£Ÿç”¨", effect: "ä¿ƒè¿›æ¶ˆåŒ–ï¼Œè¡¥å……ç»´ç”Ÿç´ " }]
                    },
                    "å‘¨äºŒ": {
                        breakfast: [],
                        lunch: [],
                        dinner: [],
                        snack: []
                    },
                    "å‘¨ä¸‰": {
                        breakfast: [],
                        lunch: [],
                        dinner: [],
                        snack: []
                    },
                    "å‘¨å››": {
                        breakfast: [],
                        lunch: [],
                        dinner: [],
                        snack: []
                    },
                    "å‘¨äº”": {
                        breakfast: [],
                        lunch: [],
                        dinner: [],
                        snack: []
                    },
                    "å‘¨å…­": {
                        breakfast: [],
                        lunch: [],
                        dinner: [],
                        snack: []
                    },
                    "å‘¨æ—¥": {
                        breakfast: [],
                        lunch: [],
                        dinner: [],
                        snack: []
                    }
                };
                
                // ä¿å­˜ç¤ºä¾‹æ•°æ®
                const encryptedSettings = encrypt(sampleSettings);
                const encryptedPlan = encrypt(samplePlan);
                
                localStorage.setItem(STORAGE_KEYS.USER_SETTINGS, encryptedSettings);
                localStorage.setItem(STORAGE_KEYS.DIET_PLAN, encryptedPlan);
                localStorage.setItem(STORAGE_KEYS.FIRST_LAUNCH, encrypt(false));
                
                output.innerHTML = `<h2>ç¤ºä¾‹æ•°æ®å·²æ¢å¤:</h2>
                    <p>ç”¨æˆ·è®¾ç½®å·²ä¿å­˜</p>
                    <p>é¥®é£Ÿè®¡åˆ’å·²ä¿å­˜</p>
                    <p>é¦–æ¬¡å¯åŠ¨æ ‡è®°å·²è®¾ç½®ä¸ºfalse</p>`;
            } catch (error) {
                output.innerHTML = `<p>æ¢å¤ç¤ºä¾‹æ•°æ®æ—¶å‡ºé”™: ${error.message}</p>`;
            }
        }
        
        // æ¸…ç©ºæ‰€æœ‰æ•°æ®
        function clearAllData() {
            const output = document.getElementById('output');
            try {
                Object.values(STORAGE_KEYS).forEach(key => {
                    localStorage.removeItem(key);
                });
                output.innerHTML = '<p>æ‰€æœ‰æ•°æ®å·²æ¸…ç©º</p>';
            } catch (error) {
                output.innerHTML = `<p>æ¸…ç©ºæ•°æ®æ—¶å‡ºé”™: ${error.message}</p>`;
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥CryptoJS
        window.addEventListener('load', () => {
            loadCryptoJS().catch(e => {
                document.getElementById('output').innerHTML = `<p>åŠ è½½CryptoJSåº“å¤±è´¥: ${e.message}</p>`;
            });
        });
    </script>
</body>
</html>